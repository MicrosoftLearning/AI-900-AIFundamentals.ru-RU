---
lab:
  title: Изучение обнаружения объектов
---

# <a name="explore-object-detection"></a>Изучение обнаружения объектов

> **Примечание**. Для выполнения этого задания вам потребуется [подписка Azure](https://azure.microsoft.com/free?azure-portal=true), в которой у вас есть административный доступ.

*Обнаружение объектов* — это разновидность компьютерного зрения. Модель машинного обучения обучается классифицировать отдельные экземпляры объектов на изображении и указывает *ограничивающую рамку*, которая отмечает их расположение. Это можно представить, как расширенную форму *классификации изображений* (модель отвечает на вопрос о том, что это за изображение) для создания решений. Мы можем спросить модель о том, какие объекты есть на этом изображении и где они находятся.

Например, продуктовый магазин может использовать модель обнаружения объектов для реализации автоматизированной системы проверки, которая сканирует конвейерную ленту с помощью камеры и может идентифицировать конкретные предметы без необходимости размещать каждый предмет на ленте и сканировать их по отдельности.

Когнитивная служба **Пользовательское визуальное распознавание** в Microsoft Azure предоставляет облачное решение для создания и публикации пользовательских моделей обнаружения объектов. В Azure можно использовать службу Пользовательского визуального распознавания для обучения модели классификации изображений на основе существующих изображений. Есть два момента, которые нужно учитывать при создании решения для классификации изображений. Во-первых, вы должны обучить модель распознавать разные классы с использованием существующих изображений. Затем, когда модель обучена, ее необходимо опубликовать как службу, которая может использоваться приложениями.

Чтобы протестировать возможности службы Пользовательского визуального распознавания по обнаружению объектов в изображениях, мы будем использовать простое приложение командной строки, которое выполняется в Cloud Shell. Те же принципы и функциональные возможности реализованы и в реальных решениях, таких как веб-сайты и приложения для телефонов.

## <a name="create-a-cognitive-services-resource"></a>Создание ресурса *Cognitive Services*

Для работы со службой "Пользовательское визуальное распознавание" можно создать ресурс **Пользовательского визуального распознавания** или **Cognitive Services**.

> **Примечание** Некоторые ресурсы недоступны в некоторых регионах. При создании как ресурса Пользовательского визуального распознавания, так и ресурса Cognitive Services для доступа к службам Пользовательского визуального распознавания можно использовать только ресурсы, созданные в [определенных регионах](https://azure.microsoft.com/global-infrastructure/services/?products=cognitive-services). Для удобства в инструкциях по конфигурации ниже регион выбран заранее.

Создайте ресурс **Cognitive Services** в подписке Azure.

1. На другой вкладке браузера откройте портал Azure по адресу [https://portal.azure.com](https://portal.azure.com?azure-portal=true) и войдите в него, используя свою учетную запись Майкрософт.

1. Нажмите кнопку **&#65291; Создать ресурс**, выполните поиск по запросу *Cognitive Services* и создайте ресурс **Cognitive Services** со следующими параметрами:
    - **Подписка**: *ваша подписка Azure*.
    - **Группа ресурсов**: *выберите существующую или создайте новую группу ресурсов с уникальным именем*.
    - **Регион:** восточная часть США.
    - **Имя**: *укажите уникальное имя*.
    - **Ценовая категория**: Стандартный S0.
    - **Устанавливая этот флажок, я подтверждаю, что мною прочитаны все приведенные ниже условия и я понимаю их**: флажок установлен.

1. Проверьте и создайте ресурс, а затем дождитесь завершения развертывания. Затем перейдите к развернутому ресурсу.

1. Откройте страницу **Ключи и конечная точка** для своего ресурса Cognitive Services. Для подключения из клиентских приложений потребуются конечная точка и ключи.

## <a name="create-a-custom-vision-project"></a>Создание проекта в службе "Пользовательское визуальное распознавание"

Чтобы обучить модель обнаружения объектов, необходимо создать проект Пользовательского визуального распознавания на основе учебного ресурса. Для этого воспользуйтесь порталом Пользовательского визуального распознавания.

1. На новой вкладке браузера откройте портал службы Пользовательского визуального распознавания ([https://customvision.ai](https://customvision.ai?azure-portal=true)) и выполните вход с учетной записью Майкрософт, связанной с вашей подпиской Azure.

1. Создайте новый проект со следующими параметрами:
    - **Имя**: обнаружение продуктов.
    - **Описание**: обнаружение объектов для продуктов.
    - **Ресурс**: *ресурс, созданный ранее*.
    - **Типы проектов**: обнаружение объектов.
    - **Домены**. Общие

1. Подождите, пока проект будет создан и открыт в браузере.

## <a name="add-and-tag-images"></a>Отправка изображений и добавление тегов

Чтобы обучить модель обнаружения объектов, вам необходимо отправить изображения, содержащие классы, которые должна идентифицировать модель, и добавить к ним теги, чтобы указать ограничивающие рамки для каждого экземпляра объекта.

1. Скачайте и извлеките обучающие изображения отсюда: https://aka.ms/fruit-objects. Извлеченная папка содержит коллекцию изображений фруктов.

1. На портале Пользовательского визуального распознавания ([https://customvision.ai](https://customvision.ai?azure-portal=true)) убедитесь, что вы работаете с проектом обнаружения объектов _Обнаружение продуктов_. Затем выберите **Добавить изображения** и отправьте все образы в извлеченной папке.

    ![Отправьте скачанные изображения, щелкнув "Добавить изображения".](media/create-object-detection-solution/fruit-upload.jpg)

1. После отправки выберите первое изображение, чтобы открыть его.

1. Удерживайте указатель мыши над любым объектом на изображении, пока не отобразится автоматически обнаруженная область, как на изображении ниже. Затем выберите объект и, если необходимо, измените размер области, чтобы окружить его.

    ![Регион по умолчанию для объекта](media/create-object-detection-solution/object-region.jpg)

    Кроме того, вы можете просто выполнить жест перетаскивания, чтобы создать область вокруг объекта.

1. Когда область будет окружать объект, добавьте новый тег с соответствующим типом объекта (*apple*, *banana* или *orange*), как показано ниже:

    ![Объект с тегами на изображении](media/create-object-detection-solution/object-tag.jpg)

1. Выделите другие объекты на изображении, изменяя размер областей и добавляя новые теги по мере необходимости.

    ![Два объекта с тегами на изображении](media/create-object-detection-solution/object-tags.jpg)

1. Используйте ссылку справа (**>**), чтобы перейти к следующему изображению и добавить теги к его объектам. Затем просто продолжайте работать со всей коллекцией изображений, добавляя теги к каждому яблоку, банану и апельсину.

1. Завершив добавление тегов к последнему изображению, закройте редактор **сведений об изображении** и на странице **Изображения для обучения** в разделе **Теги** выберите пункт **Помечено**, чтобы просмотреть все изображения с тегами:

    ![Изображения с тегами в проекте](media/create-object-detection-solution/tagged-images.jpg)

## <a name="train-and-test-a-model"></a>Обучение и тестирование модели

Теперь, когда вы пометили изображения в проекте, можно приступать к обучению модели.

1. В проекте Пользовательского визуального распознавания щелкните **Обучить**, чтобы обучить модель обнаружения объектов с использованием изображений с тегами. Выберите вариант **Быстрое обучение**.

1. Дождитесь завершения обучения (это может занять десять минут или около того), а затем просмотрите метрики производительности (*Точность*, *Полнота* и *mAP*), которые измеряют точность прогнозирования модели обнаружения объектов. Их значения должны быть высокими.

1. В правом верхнем углу страницы щелкните **Быстрый тест**, а затем в поле **URL-адрес изображения** введите `https://aka.ms/apple-orange` и просмотрите созданный прогноз. Затем закройте окно **Быстрый тест**.

## <a name="publish-the-object-detection-model"></a>Публикация модели обнаружения объектов

Теперь вы готовы опубликовать обученную модель и использовать ее из клиентского приложения.

1. Щелкните **&#128504; Опубликовать**, чтобы опубликовать обученную модель со следующими параметрами:
    - **Имя модели**: detect-produce.
    - **Ресурс прогнозирования**: *ресурс, созданный ранее*.

1. После публикации щелкните *URL-адрес прогноза* (&#127760;), чтобы просмотреть сведения, необходимые для использования опубликованной модели. Позже вам потребуются соответствующие значения URL-адреса и Prediction-Key, чтобы получить прогноз из URL-адреса изображения, поэтому оставьте это диалоговое окно открытым и переходите к следующей задаче.

## <a name="run-cloud-shell"></a>Запуск Cloud Shell

Чтобы протестировать возможности службы Компьютерного зрения, мы используем простое приложение командной строки, которое выполняется в Cloud Shell в Azure.

1. На портале Azure нажмите кнопку **[>_]** (*Cloud Shell*) в верхней части страницы справа от поля поиска. В нижней части портала откроется панель Cloud Shell. 

    ![Запустите Cloud Shell, нажав значок справа от верхнего поля поиска.](media/create-object-detection-solution/powershell-portal-guide-1.png)

1. При первом запуске Cloud Shell вам может быть предложено выбрать тип оболочки, которую вы будете использовать (*Bash* или *PowerShell*). Выберите ссылку **PowerShell**. В противном случае пропустите этот шаг.  

1. Если вам будет предложено создать хранилище для Cloud Shell, укажите свою подписку и нажмите **Создать хранилище**. Затем подождите минуту, пока хранилище не будет создано.

    ![Нажмите "Подтвердить", чтобы создать хранилище.](media/create-object-detection-solution/powershell-portal-guide-2.png)

1. Убедитесь, что тип оболочки в левом верхнем углу панели Cloud Shell изменился на *PowerShell*. Если там указана оболочка *Bash*, выберите *PowerShell* из раскрывающегося меню.

    ![Как найти раскрывающееся меню слева для переключения на PowerShell](media/create-object-detection-solution/powershell-portal-guide-3.png) 

1. Дождитесь запуска PowerShell. На портале Azure должен отобразиться следующий экран:  

    ![Дождитесь запуска PowerShell.](media/create-object-detection-solution/powershell-prompt.png) 

## <a name="configure-and-run-a-client-application"></a>Настройка и запуск клиентского приложения

Теперь, когда у вас есть пользовательская модель, вы можете запустить простое клиентское приложение, которое использует службу Пользовательского визуального распознавания для обнаружения объектов на изображении.

1. В командной оболочке введите следующую команду, чтобы скачать пример приложения и сохранить его в папку ai-900.

    ```PowerShell
    git clone https://github.com/MicrosoftLearning/AI-900-AIFundamentals ai-900
    ```

    >**Совет** Если вы уже использовали эту команду в другом задании для клонирования репозитория *ai-900*, этот шаг можно пропустить.

1. Файлы скачиваются в папку **ai-900**. Теперь нам нужно просмотреть все файлы в хранилище Cloud Shell и поработать с ними. Введите в оболочке следующую команду:

    ```PowerShell
    code .
    ```

    Обратите внимание, что откроется редактор, подобный следующему: 

    ![Редактор кода.](media/create-object-detection-solution/powershell-portal-guide-4.png)

1. В области **Файлы** слева разверните узел **ai-900** и выберите файл **detect-objects.ps1**. Этот файл содержит код, который использует службу Пользовательского визуального распознавания для обнаружения объектов на изображении, как показано ниже:

    ![Редактор, содержащий код для обнаружения объектов на изображении](media/create-object-detection-solution/detect-image-code.png)

1. Не беспокойтесь слишком о деталях кода. Важно то, что при использовании URL-адреса изображения требуется URL-адрес и ключ прогнозирования для вашей модели Пользовательского визуального распознавания. 

    Получите *URL-адрес прогнозирования* из диалогового окна в проекте Пользовательского визуального распознавания. 

    >**Примечание** Помните, что вы просматривали этот *URL-адрес прогнозирования* после публикации модели классификации изображений. Чтобы найти *URL-адрес прогнозирования*, перейдите на вкладку **Производительность** в проекте, а затем щелкните **Prediction URL** (URL-адрес прогнозирования) (если экран сжат, может отображаться только значок глобуса). Появится диалоговое окно. Скопируйте URL-адрес для поля **При наличии URL-адреса изображения**. Вставьте его в редактор кода, заменив значение заполнителя **YOUR_PREDICTION_URL**. 

    В этом же диалоговом окне получите *ключ прогнозирования*. Скопируйте ключ прогнозирования, отображаемый после нажатия *Задать значение для заголовка ключа прогнозирования*. Вставьте его в редактор кода, заменив значение заполнителя **YOUR_PREDICTION_KEY**. 

    ![Снимок экрана: URL-адрес прогнозирования.](media/create-object-detection-solution/find-prediction-url.png)

    Когда вы вставите значения URL-адреса и ключа прогнозирования, первые две строки кода должны выглядеть так:

    ```PowerShell
    $predictionUrl="https..."
    $predictionKey ="1a2b3c4d5e6f7g8h9i0j...."
    ```

1. В правом верхнем углу панели редактора нажмите кнопку **...**, чтобы открыть меню, и выберите **Сохранить**, чтобы сохранить свои изменения. Затем снова откройте меню и выберите пункт **Закрыть редактор**.

    Для обнаружения объектов на этом изображении будет использоваться пример клиентского приложения:

    ![Изображение фрукта](media/create-object-detection-solution/produce.jpg)

1. В области PowerShell введите следующую команду, чтобы выполнить код:

    ```PowerShell
    cd ai-900
    ./detect-objects.ps1 
    ```

1. Ознакомьтесь с прогнозом, который должен выглядеть так: *apple orange banana*.

## <a name="learn-more"></a>Дополнительные сведения

В этом простом приложении демонстрируются лишь некоторые возможности службы Пользовательского визуального распознавания. Дополнительные сведения о том, что можно сделать с помощью этой службы, см. на [странице Пользовательского визуального распознавания](https://azure.microsoft.com/services/cognitive-services/custom-vision-service/).
